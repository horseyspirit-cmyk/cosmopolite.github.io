<script>
    // ============ Events List View ============
    function renderEventsListView() {
      const container = document.getElementById('eventsListView');
      
      const filteredEvents = events.filter(e => 
        activeFilters.size === 0 || activeFilters.has(e.category)
      ).sort((a, b) => parseDate(a.startDate) - parseDate(b.startDate));
      
      let html = `
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-bold tracking-tight">Все события ${YEAR}</h2>
          <p class="text-stone-500 dark:text-stone-400 mt-1">${filteredEvents.length} событий</p>
        </div>
        
        <!-- Уточнение про возможные изменения дат -->
        <div class="mb-6 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
              <p class="text-sm text-amber-800 dark:text-amber-200 font-medium">Некоторые даты могут меняться</p>
              <p class="text-xs text-amber-600 dark:text-amber-400 mt-1">Даты событий могут быть скорректированы организаторами. Рекомендуем проверять актуальную информацию на официальных источниках перед планированием поездки.</p>
            </div>
          </div>
        </div>
        
        <!-- Events Table -->
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-sm overflow-hidden border-2 border-dashed border-accent/40 dark:border-accent/60">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-stone-200 dark:border-stone-700">
                  <th class="text-left px-6 py-4 text-sm font-semibold text-stone-600 dark:text-stone-300">Название</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-stone-600 dark:text-stone-300">Даты</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-stone-600 dark:text-stone-300 hidden sm:table-cell">Тип</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-stone-600 dark:text-stone-300 hidden md:table-cell">Место</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-stone-600 dark:text-stone-300">Ссылка</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      if (filteredEvents.length === 0) {
        html += `
          <tr>
            <td colspan="5" class="px-6 py-12 text-center">
              <svg class="w-16 h-16 mx-auto text-stone-300 dark:text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2v12a2 2 0 002 2z"></path>
              </svg>
              <p class="mt-4 text-stone-500 dark:text-stone-400">Нет событий для отображения</p>
            </td>
          </tr>
        `;
      } else {
        filteredEvents.forEach(e => {
          const startDate = parseDate(e.startDate);
          const endDate = parseDate(e.endDate);
          const isSingleDay = e.startDate === e.endDate;
          const category = categories.find(c => c.id === e.category);
          const dateStr = isSingleDay 
            ? formatDate(startDate) 
            : `${startDate.getDate()} ${MONTH_NAMES_GEN[startDate.getMonth()]} — ${endDate.getDate()} ${MONTH_NAMES_GEN[endDate.getMonth()]}`;
          
          // Подготовка текста для тултипа (максимум 200 символов)
          const tooltipText = e.description && e.description.trim() !== '' 
            ? (e.description.length > 200 ? e.description.substring(0, 200) + '...' : e.description)
            : 'Нет описания';
          
          html += `
            <tr class="border-b border-stone-100 dark:border-stone-800 hover:bg-stone-50 dark:hover:bg-stone-800/50 transition-colors cursor-pointer event-row relative group"
                data-event-id="${e.id}"
                title="${tooltipText.replace(/"/g, '&quot;')}">
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="w-1 h-8 rounded-full" style="background-color: ${e.color}"></div>
                  <span class="font-medium text-stone-900 dark:text-white">${e.title}</span>
                </div>
              </td>
              <td class="px-6 py-4 text-stone-600 dark:text-stone-300 text-sm">${dateStr}</td>
              <td class="px-6 py-4 hidden sm:table-cell">
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${e.color}20; color: ${e.color}">
                  ${category ? category.name : e.category}
                </span>
              </td>
              <td class="px-6 py-4 text-stone-500 dark:text-stone-400 hidden md:table-cell">${e.location || '—'}</td>
              <td class="px-6 py-4">
                ${e.url && e.url.trim() !== '' ? `
                  <a href="${e.url}" target="_blank" rel="noopener noreferrer" 
                     class="inline-flex items-center gap-1 text-accent hover:text-accent-dark transition-colors text-sm"
                     onclick="event.stopPropagation()">
                    <span>Открыть</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </a>
                ` : '<span class="text-stone-400 dark:text-stone-500">—</span>'}
              </td>
              
              <!-- Улучшенный тултип при наведении -->
              <div class="event-tooltip absolute z-10 hidden group-hover:block bg-white dark:bg-surface-800 p-4 rounded-lg shadow-2xl border border-stone-200 dark:border-stone-700 max-w-xs pointer-events-none"
                   style="left: 50%; transform: translateX(-50%); top: calc(100% + 10px);">
                <div class="relative">
                  <!-- Стрелочка тултипа -->
                  <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white dark:bg-surface-800 border-t border-l border-stone-200 dark:border-stone-700 rotate-45"></div>
                  
                  <div class="relative z-20">
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-2 h-2 rounded-full" style="background-color: ${e.color}"></div>
                      <span class="text-xs font-medium text-stone-500 dark:text-stone-400">${category ? category.name : e.category}</span>
                    </div>
                    <h4 class="font-semibold text-stone-900 dark:text-white mb-2">${e.title}</h4>
                    ${e.description && e.description.trim() !== '' ? `
                      <p class="text-sm text-stone-600 dark:text-stone-300 line-clamp-3">${e.description}</p>
                    ` : '<p class="text-sm text-stone-400 dark:text-stone-500 italic">Нет описания</p>'}
                    ${e.location && e.location.trim() !== '' ? `
                      <div class="flex items-center gap-1 mt-2 text-xs text-stone-500 dark:text-stone-400">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        </svg>
                        <span>${e.location}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </tr>
          `;
        });
      }
      
      html += `
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Подсказка по взаимодействию -->
        <div class="mt-4 text-center text-sm text-stone-500 dark:text-stone-400">
          <p class="flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Наведите на событие для предпросмотра или кликните для подробной информации</span>
          </p>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Add event click handlers for modal
      container.querySelectorAll('.event-row').forEach(el => {
        el.addEventListener('click', (e) => {
          // Не открываем модальное окно, если клик был на ссылке
          if (e.target.closest('a')) return;
          
          const eventId = el.dataset.eventId;
          const event = events.find(ev => ev.id === eventId);
          if (event) showEventModal(event);
        });
      });
      
      // Управление тултипами
      const rows = container.querySelectorAll('.event-row');
      rows.forEach(row => {
        const tooltip = row.querySelector('.event-tooltip');
        
        // Показываем/скрываем тултип при наведении
        row.addEventListener('mouseenter', () => {
          tooltip.classList.remove('hidden');
        });
        
        row.addEventListener('mouseleave', () => {
          tooltip.classList.add('hidden');
        });
        
        // Позиционирование тултипа
        row.addEventListener('mousemove', (e) => {
          const rect = row.getBoundingClientRect();
          const tooltipRect = tooltip.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          
          // Автоматическое позиционирование слева/справа если тултип выходит за экран
          let left = e.clientX - rect.left;
          
          // Проверяем, не выходит ли тултип за правый край
          if (left + tooltipRect.width > viewportWidth - 20) {
            left = viewportWidth - tooltipRect.width - 20 - rect.left;
          }
          
          // Проверяем, не выходит ли тултип за левый край
          if (left < 20) {
            left = 20;
          }
          
          tooltip.style.left = `${left}px`;
          tooltip.style.transform = 'none';
        });
      });
    }
</script>

<style>
  /* Стили для тултипов в таблице */
  .event-tooltip {
    animation: fadeInTooltip 0.2s ease-out;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  .dark .event-tooltip {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 5px 15px rgba(0, 0, 0, 0.3);
  }
  
  @keyframes fadeInTooltip {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Ограничение текста в 3 строки */
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Курсор-указатель для строк таблицы */
  .event-row {
    cursor: pointer;
    position: relative;
  }
  
  .event-row:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }
  
  .dark .event-row:hover {
    background-color: rgba(255, 255, 255, 0.02);
  }
</style>